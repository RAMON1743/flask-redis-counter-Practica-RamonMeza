version: 2.1

orbs:
  python: circleci/python@1.3.0

jobs:
  build:
    docker:
      - image: cimg/python:3.9
      - image: redis:7
        name: redis  # 游늷 Asignar un alias para garantizar que Flask lo encuentre
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true  # 游늷 Habilitar Docker en CircleCI
      - run:
          name: Convertir DOCKERHUB_REPO a min칰sculas
          command: echo "export DOCKERHUB_REPO=$(echo $DOCKERHUB_REPO | tr '[:upper:]' '[:lower:]')" >> $BASH_ENV
      - run:
          name: Instalar redis-tools para verificar Redis
          command: sudo apt-get update && sudo apt-get install -y redis-tools netcat
      - run:
          name: Verificar si Redis est치 en ejecuci칩n
          command: |
            sleep 5  # Dar tiempo a que Redis arranque
            echo "Verificando contenedores en ejecuci칩n:"
            docker ps -a  # Verificar si Redis est치 corriendo en Docker
            echo "Verificando procesos de Redis:"
            ps aux | grep redis  # Verificar si hay procesos de Redis
            echo "Verificando puertos abiertos en el sistema:"
            netstat -tln  # Verificar si Redis est치 escuchando en el puerto 6379
      - run:
          name: Configurar Redis en Flask
          command: echo "export REDIS_HOST=redis" >> $BASH_ENV && echo "export REDIS_PORT=6379" >> $BASH_ENV  # 游늷 Agregar variables de entorno
      - run:
          name: Esperar a que Redis est칠 listo
          command: |
            for i in {1..10}; do
              nc -z redis 6379 && echo "Redis est치 listo" && exit 0
              echo "Esperando a Redis..."
              sleep 3
            done
            echo "Redis no respondi칩 a tiempo" && exit 1
      - run:
          name: Verificar conexi칩n a Redis antes de ejecutar Flask
          command: |
            echo "Probando conexi칩n con Redis..."
            ping -c 3 redis || echo "No se pudo hacer ping a Redis"
            nc -zv redis 6379 || echo "No se pudo conectar al puerto 6379"
      - run:
          name: Configurar PYTHONPATH
          command: echo "export PYTHONPATH=$PYTHONPATH:$(pwd)" >> $BASH_ENV
      - run:
          name: Instalar dependencias
          command: pip install --no-cache-dir -r requirements.txt
      - run:
          name: Ejecutar pruebas
          command: pytest --cov=app --cov-report=xml
      - run:
          name: An치lisis est치tico de c칩digo con pylint
          command: pylint --disable=C0303 app  # 游늷 Desactivar trailing-whitespace en Pylint
      - run:
          name: Linting con flake8
          command: flake8 app
      - run:
          name: Construir imagen Docker
          command: docker build -t $DOCKERHUB_REPO:latest .

  push_docker:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Convertir DOCKERHUB_REPO a min칰sculas
          command: echo "export DOCKERHUB_REPO=$(echo $DOCKERHUB_REPO | tr '[:upper:]' '[:lower:]')" >> $BASH_ENV
      - run:
          name: Iniciar sesi칩n en Docker Hub
          command: echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run:
          name: Construir imagen Docker
          command: docker build -t $DOCKERHUB_REPO:latest .
      - run:
          name: Etiquetar imagen con el commit SHA
          command: docker tag $DOCKERHUB_REPO:latest $DOCKERHUB_REPO:${CIRCLE_SHA1}
      - run:
          name: Subir imagen a Docker Hub
          command: |
            docker push $DOCKERHUB_REPO:latest
            docker push $DOCKERHUB_REPO:${CIRCLE_SHA1}

  vulnerability_scan:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - run:
          name: Instalar Node.js y Snyk CLI
          command: |
            sudo apt update
            sudo apt install -y nodejs npm
            mkdir -p "$HOME/.npm-global/bin"
            npm config set prefix "$HOME/.npm-global"
            export PATH="$HOME/.npm-global/bin:$PATH"
            echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> $BASH_ENV
            npm install -g snyk
            snyk --version  # Verificar que Snyk est치 instalado correctamente
      - run:
          name: Instalar dependencias del proyecto antes de ejecutar Snyk
          command: pip install --no-cache-dir -r requirements.txt
      - run:
          name: Autenticar con Snyk
          command: snyk auth $SNYK_TOKEN
      - run:
          name: Ejecutar an치lisis de vulnerabilidades
          command: snyk test

workflows:
  version: 2
  build_test_and_push:
    jobs:
      - build
      - vulnerability_scan:
          requires:
            - build
      - push_docker:
          requires:
            - build
            - vulnerability_scan
          filters:
            branches:
              only:
                - master
                - main
